name: Build and Deploy

on:
  push:
    branches:
    - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Set up PyPy
        uses: actions/setup-python@v2
        with:
          python-version: 'pypy3'
      - name: Set up Repo Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - run: mkdir public && cp -r ./{males,females,dogs.htm,style.css} ./public
      - run: python photo_generation.py public
      - name: Build HTML and Image Files
        run: python ../src/build_site.py ../res
        working-directory: ./public
      - name: Build CSS Files
        uses: gha-utilities/sass-build@v0.3.7
        with:
          source: res/common.scss
          destination: public/common.css
      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: public
          path: public
          retention-days: 3

  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@master
        with:
          name: public
          path: public
      - name: Validate Hyperlink and Image Targets
        uses: chabad360/htmlproofer@master
        with:
          directory: "./public"

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@master
        with:
          name: public
          path: public
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: fontefideliti
