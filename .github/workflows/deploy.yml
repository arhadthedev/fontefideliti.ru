name: Build and Deploy

on:
  push:
    branches:
    - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Set up Repo Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Create a Build Directory
        run: mkdir public
      - name: Build HTML and Image Files
        run: python ../src/build_site.py ../res
        working-directory: ./public
      - name: Build CSS Files
        uses: gha-utilities/sass-build@v0.3.7
        with:
          source: res/common.scss
          destination: public/common.css
      - name: Upload Site Content Artifact
        uses: actions/upload-artifact@v2
        with:
          name: public
          path: public
          retention-days: 3
      - name: Upload Firebase Project Artifact
        uses: actions/upload-artifact@v2
        with:
          name: firebase.json
          path: firebase.json
          retention-days: 3

  test:
    name: Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@master
        with:
          name: public
          path: public
      - name: Validate Hyperlink and Image Targets
        uses: chabad360/htmlproofer@master
        with:
          directory: "./public"
      - name: Validate HTML and CSS Conformance
        id: html_css_conformance
        uses: Cyb3r-Jak3/html5validator-action@master
        with:
          css: true
          root: public/

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Site Content Artifact
        uses: actions/download-artifact@master
        with:
          name: public
          path: public
      - name: Firebase Project Artifact
        uses: actions/download-artifact@master
        with:
          name: firebase.json
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: fontefideliti
